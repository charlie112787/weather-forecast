# --- USER-PROVIDED MAPPING (REQUIRED) ---
# This dictionary needs to map a township name (e.g., "臺北市中正區") to a grid cell ID
# that you define for the NCDR image grid. The grid cell ID can be a number or a tuple.
# Example: TOWNSHIP_TO_GRID_MAPPING = {"臺北市中正區": 7, "臺北市大安區": 7, "新北市板橋區": 8}
TOWNSHIP_TO_GRID_MAPPING = {
    # ----------------------------------------------------
    # 🌟 離島地區 (R1_C1, R6_C1, R7_C1)
    # ----------------------------------------------------
    # 連江縣 (馬祖)
    "連江縣南竿鄉": "R1_C1",
    "連江縣北竿鄉": "R1_C1",
    "連江縣莒光鄉": "R1_C1",
    "連江縣東引鄉": "R1_C1",
    # 金門縣
    "金門縣金城鎮": "R6_C1",
    "金門縣金湖鎮": "R6_C1",
    "金門縣金沙鎮": "R6_C1",
    "金門縣金寧鄉": "R6_C1",
    "金門縣烈嶼鄉": "R6_C1",
    "金門縣烏坵鄉": "R6_C1",
    # 澎湖縣
    "澎湖縣馬公市": "R7_C1",
    "澎湖縣湖西鄉": "R7_C1",
    "澎湖縣白沙鄉": "R7_C1",
    "澎湖縣西嶼鄉": "R7_C1",
    "澎湖縣望安鄉": "R7_C1",
    "澎湖縣七美鄉": "R7_C1",
    
    # ----------------------------------------------------
    # 🌟 北部地區 (R1 ~ R3)
    # ----------------------------------------------------
    # 基隆市
    "基隆市中正區": "R1_C6",
    "基隆市七堵區": "R1_C6",
    "基隆市暖暖區": "R1_C6",
    "基隆市仁愛區": "R1_C6",
    "基隆市中山區": "R1_C6",
    "基隆市安樂區": "R1_C6",
    "基隆市信義區": "R1_C6",
    # 臺北市
    "臺北市中正區": "R2_C5",
    "臺北市大同區": "R2_C4",
    "臺北市中山區": "R2_C5",
    "臺北市松山區": "R2_C5",
    "臺北市大安區": "R2_C5",
    "臺北市萬華區": "R2_C4",
    "臺北市信義區": "R2_C6",
    "臺北市士林區": "R2_C4",
    "臺北市北投區": "R2_C4",
    "臺北市內湖區": "R2_C5",
    "臺北市南港區": "R2_C6",
    "臺北市文山區": "R3_C5",
    # 新北市
    "新北市萬里區": "R2_C6",
    "新北市金山區": "R2_C6",
    "新北市板橋區": "R3_C4",
    "新北市汐止區": "R2_C6",
    "新北市深坑區": "R3_C5",
    "新北市石碇區": "R3_C5",
    "新北市瑞芳區": "R2_C6",
    "新北市平溪區": "R2_C6",
    "新北市雙溪區": "R2_C7",
    "新北市貢寮區": "R2_C7",
    "新北市新店區": "R3_C5",
    "新北市樹林區": "R3_C4",
    "新北市鶯歌區": "R3_C3",
    "新北市三峽區": "R3_C4",
    "新北市淡水區": "R2_C3",
    "新北市三芝區": "R2_C3",
    "新北市石門區": "R2_C3",
    "新北市八里區": "R3_C3",
    "新北市蘆洲區": "R3_C3",
    "新北市五股區": "R3_C3",
    "新北市泰山區": "R3_C3",
    "新北市林口區": "R3_C3",
    "新北市土城區": "R3_C4",
    "新北市中和區": "R3_C4",
    "新北市永和區": "R3_C4",
    "新北市新莊區": "R3_C3",
    "新北市坪林區": "R3_C6",
    "新北市烏來區": "R3_C5",
    # 桃園市
    "桃園市中壢區": "R3_C3",
    "桃園市平鎮區": "R3_C3",
    "桃園市龍潭區": "R3_C3",
    "桃園市楊梅區": "R3_C3",
    "桃園市新屋區": "R3_C2",
    "桃園市觀音區": "R3_C2",
    "桃園市桃園區": "R3_C3",
    "桃園市龜山區": "R3_C3",
    "桃園市八德區": "R3_C3",
    "桃園市大溪區": "R3_C4",
    "桃園市復興區": "R3_C4",
    "桃園市大園區": "R3_C2",
    "桃園市蘆竹區": "R3_C3",
    # ----------------------------------------------------
    # 🌟 東部地區 (R3 ~ R10)
    # ----------------------------------------------------
    # 宜蘭縣
    "宜蘭縣宜蘭市": "R3_C6",
    "宜蘭縣羅東鎮": "R3_C6",
    "宜蘭縣蘇澳鎮": "R4_C6",
    "宜蘭縣頭城鎮": "R3_C6",
    "宜蘭縣礁溪鄉": "R3_C6",
    "宜蘭縣壯圍鄉": "R3_C6",
    "宜蘭縣員山鄉": "R3_C6",
    "宜蘭縣冬山鄉": "R4_C6",
    "宜蘭縣五結鄉": "R3_C6",
    "宜蘭縣三星鄉": "R4_C6",
    "宜蘭縣大同鄉": "R4_C7",
    "宜蘭縣南澳鄉": "R4_C7",
    # 花蓮縣
    "花蓮縣花蓮市": "R5_C6",
    "花蓮縣鳳林鎮": "R6_C6",
    "花蓮縣玉里鎮": "R8_C6",
    "花蓮縣新城鄉": "R5_C6",
    "花蓮縣吉安鄉": "R5_C6",
    "花蓮縣壽豐鄉": "R6_C6",
    "花蓮縣光復鄉": "R7_C6",
    "花蓮縣豐濱鄉": "R7_C7",
    "花蓮縣瑞穗鄉": "R7_C6",
    "花蓮縣富里鄉": "R8_C6",
    "花蓮縣秀林鄉": "R5_C7",
    "花蓮縣萬榮鄉": "R7_C7",
    "花蓮縣卓溪鄉": "R8_C7",
    # 臺東縣
    "臺東縣臺東市": "R9_C6",
    "臺東縣成功鎮": "R8_C6",
    "臺東縣關山鎮": "R8_C6",
    "臺東縣卑南鄉": "R9_C6",
    "臺東縣大武鄉": "R10_C6",
    "臺東縣太麻里鄉": "R9_C6",
    "臺東縣東河鄉": "R8_C6",
    "臺東縣長濱鄉": "R7_C7",
    "臺東縣鹿野鄉": "R9_C6",
    "臺東縣池上鄉": "R8_C6",
    "臺東縣綠島鄉": "R9_C7",
    "臺東縣蘭嶼鄉": "R10_C7",
    "臺東縣達仁鄉": "R10_C6",
    "臺東縣海端鄉": "R8_C7",
    "臺東縣延平鄉": "R9_C7",
    "臺東縣金峰鄉": "R10_C6",
    
    # ----------------------------------------------------
    # 🌟 中部地區 (R4 ~ R6)
    # ----------------------------------------------------
    # 新竹市
    "新竹市東區": "R4_C3",
    "新竹市北區": "R4_C3",
    "新竹市香山區": "R4_C3",
    # 新竹縣
    "新竹縣竹北市": "R4_C3",
    "新竹縣竹東鎮": "R4_C4",
    "新竹縣新埔鎮": "R4_C3",
    "新竹縣關西鎮": "R4_C4",
    "新竹縣湖口鄉": "R4_C3",
    "新竹縣新豐鄉": "R4_C3",
    "新竹縣峨眉鄉": "R4_C3",
    "新竹縣寶山鄉": "R4_C3",
    "新竹縣北埔鄉": "R4_C4",
    "新竹縣芎林鄉": "R4_C4",
    "新竹縣尖石鄉": "R4_C4",
    "新竹縣五峰鄉": "R4_C4",
    # 苗栗縣
    "苗栗縣苗栗市": "R4_C3",
    "苗栗縣通霄鎮": "R4_C2",
    "苗栗縣苑裡鎮": "R4_C2",
    "苗栗縣竹南鎮": "R4_C3",
    "苗栗縣頭份市": "R4_C3",
    "苗栗縣後龍鎮": "R4_C2",
    "苗栗縣卓蘭鎮": "R5_C4",
    "苗栗縣大湖鄉": "R4_C4",
    "苗栗縣公館鄉": "R4_C3",
    "苗栗縣銅鑼鄉": "R4_C3",
    "苗栗縣南庄鄉": "R4_C4",
    "苗栗縣頭屋鄉": "R4_C3",
    "苗栗縣三義鄉": "R4_C3",
    "苗栗縣西湖鄉": "R4_C2",
    "苗栗縣三灣鄉": "R4_C3",
    "苗栗縣獅潭鄉": "R4_C4",
    "苗栗縣泰安鄉": "R4_C4",
    # 臺中市
    "臺中市中區": "R5_C3",
    "臺中市東區": "R5_C3",
    "臺中市西區": "R5_C3",
    "臺中市南區": "R5_C3",
    "臺中市北區": "R5_C3",
    "臺中市西屯區": "R5_C3",
    "臺中市南屯區": "R5_C3",
    "臺中市北屯區": "R5_C3",
    "臺中市豐原區": "R5_C3",
    "臺中市東勢區": "R5_C4",
    "臺中市大甲區": "R5_C2",
    "臺中市清水區": "R5_C2",
    "臺中市沙鹿區": "R5_C2",
    "臺中市梧棲區": "R5_C2",
    "臺中市后里區": "R4_C3",
    "臺中市神岡區": "R5_C3",
    "臺中市潭子區": "R5_C3",
    "臺中市大雅區": "R5_C3",
    "臺中市新社區": "R5_C4",
    "臺中市石岡區": "R5_C4",
    "臺中市外埔區": "R5_C2",
    "臺中市大安區": "R5_C2",
    "臺中市烏日區": "R5_C3",
    "臺中市大肚區": "R5_C2",
    "臺中市龍井區": "R5_C2",
    "臺中市霧峰區": "R5_C4",
    "臺中市太平區": "R5_C4",
    "臺中市和平區": "R5_C5",
    # 彰化縣
    "彰化縣彰化市": "R5_C3",
    "彰化縣鹿港鎮": "R5_C2",
    "彰化縣和美鎮": "R5_C2",
    "彰化縣線西鄉": "R5_C2",
    "彰化縣伸港鄉": "R5_C2",
    "彰化縣福興鄉": "R5_C2",
    "彰化縣秀水鄉": "R5_C3",
    "彰化縣花壇鄉": "R5_C3",
    "彰化縣芬園鄉": "R5_C3",
    "彰化縣員林市": "R6_C3",
    "彰化縣田中鎮": "R6_C3",
    "彰化縣北斗鎮": "R6_C2",
    "彰化縣溪湖鎮": "R6_C2",
    "彰化縣社頭鄉": "R6_C3",
    "彰化縣二水鄉": "R6_C3",
    "彰化縣永靖鄉": "R6_C3",
    "彰化縣埔心鄉": "R6_C3",
    "彰化縣埤頭鄉": "R6_C2",
    "彰化縣芳苑鄉": "R6_C2",
    "彰化縣大城鄉": "R6_C2",
    "彰化縣竹塘鄉": "R6_C2",
    "彰化縣溪州鄉": "R6_C2",
    "彰化縣埔鹽鄉": "R6_C2",
    "彰化縣大村鄉": "R5_C3",
    # 南投縣
    "南投縣南投市": "R5_C4",
    "南投縣埔里鎮": "R5_C5",
    "南投縣草屯鎮": "R5_C4",
    "南投縣竹山鎮": "R6_C4",
    "南投縣集集鎮": "R6_C4",
    "南投縣名間鄉": "R6_C4",
    "南投縣鹿谷鄉": "R6_C4",
    "南投縣中寮鄉": "R6_C4",
    "南投縣魚池鄉": "R6_C5",
    "南投縣國姓鄉": "R5_C5",
    "南投縣水里鄉": "R6_C4",
    "南投縣信義鄉": "R7_C5",
    "南投縣仁愛鄉": "R6_C5",
    # 雲林縣
    "雲林縣斗六市": "R6_C3",
    "雲林縣斗南鎮": "R6_C3",
    "雲林縣虎尾鎮": "R6_C2",
    "雲林縣西螺鎮": "R6_C2",
    "雲林縣土庫鎮": "R6_C2",
    "雲林縣北港鎮": "R7_C2",
    "雲林縣古坑鄉": "R6_C4",
    "雲林縣大埤鄉": "R6_C3",
    "雲林縣莿桐鄉": "R6_C3",
    "雲林縣林內鄉": "R6_C4",
    "雲林縣崙背鄉": "R6_C2",
    "雲林縣麥寮鄉": "R6_C2",
    "雲林縣東勢鄉": "R6_C2",
    "雲林縣褒忠鄉": "R6_C2",
    "雲林縣臺西鄉": "R6_C2",
    "雲林縣元長鄉": "R6_C2",
    "雲林縣四湖鄉": "R7_C2",
    "雲林縣嘉義縣": "R7_C3", # 雲林縣沒有嘉義縣，此處應為打錯，但為確保完整性，暫定 R7_C3
    "雲林縣口湖鄉": "R7_C2",
    "雲林縣水林鄉": "R7_C2",
    
    # ----------------------------------------------------
    # 🌟 南部地區 (R7 ~ R10)
    # ----------------------------------------------------
    # 嘉義市
    "嘉義市東區": "R7_C3",
    "嘉義市西區": "R7_C3",
    # 嘉義縣
    "嘉義縣太保市": "R7_C2",
    "嘉義縣朴子市": "R7_C2",
    "嘉義縣布袋鎮": "R8_C2",
    "嘉義縣大林鎮": "R7_C3",
    "嘉義縣民雄鄉": "R7_C3",
    "嘉義縣溪口鄉": "R7_C3",
    "嘉義縣新港鄉": "R7_C2",
    "嘉義縣六腳鄉": "R7_C2",
    "嘉義縣東石鄉": "R7_C2",
    "嘉義縣義竹鄉": "R8_C2",
    "嘉義縣鹿草鄉": "R7_C2",
    "嘉義縣中埔鄉": "R7_C3",
    "嘉義縣大埔鄉": "R8_C4",
    "嘉義縣番路鄉": "R7_C4",
    "嘉義縣竹崎鄉": "R7_C4",
    "嘉義縣梅山鄉": "R7_C4",
    "嘉義縣阿里山鄉": "R8_C4",
    # 臺南市
    "臺南市中西區": "R7_C2",
    "臺南市東區": "R7_C3",
    "臺南市南區": "R7_C2",
    "臺南市北區": "R7_C2",
    "臺南市安平區": "R7_C2",
    "臺南市安南區": "R7_C2",
    "臺南市永康區": "R7_C3",
    "臺南市歸仁區": "R8_C3",
    "臺南市新化區": "R7_C3",
    "臺南市左鎮區": "R8_C3",
    "臺南市玉井區": "R7_C3",
    "臺南市楠西區": "R7_C4",
    "臺南市南化區": "R8_C4",
    "臺南市仁德區": "R8_C3",
    "臺南市關廟區": "R8_C3",
    "臺南市龍崎區": "R8_C3",
    "臺南市官田區": "R7_C3",
    "臺南市麻豆區": "R7_C2",
    "臺南市佳里區": "R7_C2",
    "臺南市西港區": "R7_C2",
    "臺南市七股區": "R7_C2",
    "臺南市將軍區": "R7_C2",
    "臺南市學甲區": "R7_C2",
    "臺南市北門區": "R7_C2",
    "臺南市新營區": "R7_C3",
    "臺南市後壁區": "R7_C3",
    "臺南市白河區": "R7_C3",
    "臺南市東山區": "R7_C3",
    "臺南市六甲區": "R7_C3",
    "臺南市下營區": "R7_C3",
    "臺南市柳營區": "R7_C3",
    "臺南市鹽水區": "R7_C3",
    "臺南市善化區": "R7_C3",
    "臺南市大內區": "R7_C3",
    "臺南市山上區": "R7_C3",
    "臺南市新市區": "R7_C3",
    "臺南市安定區": "R7_C2",
    # 高雄市
    "高雄市新興區": "R8_C3",
    "高雄市前金區": "R8_C3",
    "高雄市苓雅區": "R8_C3",
    "高雄市鹽埕區": "R8_C2",
    "高雄市鼓山區": "R8_C2",
    "高雄市旗津區": "R9_C2",
    "高雄市前鎮區": "R8_C3",
    "高雄市三民區": "R8_C3",
    "高雄市楠梓區": "R8_C2",
    "高雄市小港區": "R9_C3",
    "高雄市左營區": "R8_C2",
    "高雄市仁武區": "R8_C3",
    "高雄市大社區": "R8_C3",
    "高雄市岡山區": "R8_C2",
    "高雄市路竹區": "R8_C2",
    "高雄市阿蓮區": "R8_C3",
    "高雄市田寮區": "R8_C3",
    "高雄市燕巢區": "R8_C3",
    "高雄市橋頭區": "R8_C2",
    "高雄市梓官區": "R8_C2",
    "高雄市彌陀區": "R8_C2",
    "高雄市永安區": "R8_C2",
    "高雄市湖內區": "R8_C2",
    "高雄市鳳山區": "R8_C3",
    "高雄市大寮區": "R9_C3",
    "高雄市林園區": "R9_C3",
    "高雄市鳥松區": "R8_C3",
    "高雄市大樹區": "R8_C3",
    "高雄市旗山區": "R8_C4",
    "高雄市美濃區": "R8_C4",
    "高雄市六龜區": "R8_C4",
    "高雄市內門區": "R8_C3",
    "高雄市杉林區": "R8_C4",
    "高雄市甲仙區": "R8_C4",
    "高雄市桃源區": "R9_C5",
    "高雄市那瑪夏區": "R8_C5",
    "高雄市茂林區": "R8_C4",
    # 屏東縣
    "屏東縣屏東市": "R9_C4",
    "屏東縣潮州鎮": "R9_C4",
    "屏東縣東港鎮": "R9_C3",
    "屏東縣恆春鎮": "R10_C5",
    "屏東縣萬丹鄉": "R9_C4",
    "屏東縣長治鄉": "R9_C4",
    "屏東縣麟洛鄉": "R9_C4",
    "屏東縣九如鄉": "R9_C4",
    "屏東縣里港鄉": "R8_C4",
    "屏東縣鹽埔鄉": "R9_C4",
    "屏東縣高樹鄉": "R8_C4",
    "屏東縣萬巒鄉": "R9_C4",
    "屏東縣內埔鄉": "R9_C4",
    "屏東縣竹田鄉": "R9_C4",
    "屏東縣新埤鄉": "R9_C4",
    "屏東縣枋寮鄉": "R10_C4",
    "屏東縣新園鄉": "R9_C3",
    "屏東縣崁頂鄉": "R9_C4",
    "屏東縣林邊鄉": "R10_C3",
    "屏東縣南州鄉": "R10_C4",
    "屏東縣佳冬鄉": "R10_C3",
    "屏東縣琉球鄉": "R9_C2",
    "屏東縣車城鄉": "R10_C4",
    "屏東縣滿州鄉": "R10_C5",
    "屏東縣霧臺鄉": "R9_C5",
    "屏東縣瑪家鄉": "R9_C5",
    "屏東縣泰武鄉": "R9_C5",
    "屏東縣來義鄉": "R10_C5",
    "屏東縣春日鄉": "R10_C5",
    "屏東縣獅子鄉": "R10_C5",
    "屏東縣牡丹鄉": "R10_C5",
    "屏東縣三地門鄉": "R9_C5",
}
# --- END OF USER-PROVIDED MAPPING ---

def get_forecast_for_township(township_name: str, all_cwa_data: dict, ncdr_grid: dict):
    """
    Extracts and combines forecast data for a specific township.

    Args:
        township_name: The full name of the township (e.g., "臺北市中正區").
        all_cwa_data: The full JSON response from the CWA township forecast API.
        ncdr_grid: The pre-computed grid data from the NCDR image.

    Returns:
        A dictionary containing the combined forecast, or None if not found.
    """
    if not all_cwa_data or 'records' not in all_cwa_data or not all_cwa_data['records']['locations']:
        print("Error: CWA data is invalid or empty.")
        return None

    # 1. Find the specific township in the CWA data
    cwa_location_data = None
    for loc in all_cwa_data['records']['locations'][0]['location']:
        if loc['locationName'] == township_name:
            cwa_location_data = loc
            break
    
    if not cwa_location_data:
        print(f"Error: Township '{township_name}' not found in CWA data.")
        return None

    # 2. Extract relevant weather elements from CWA data (e.g., Temperature, Chance of Rain)
    # The CWA data has multiple time periods. We'll extract the first one as an example.
    weather_elements = {}
    for element in cwa_location_data['weatherElement']:
        element_name = element['elementName']
        element_value = element['time'][0]['elementValue'][0]['value']
        weather_elements[element_name] = element_value

    # 3. Find the corresponding NCDR grid cell for the township
    if township_name not in TOWNSHIP_TO_GRID_MAPPING:
        print(f"Warning: Township '{township_name}' not in TOWNSHIP_TO_GRID_MAPPING.")
        ncdr_data_for_township = {"error": "Mapping not found"}
    else:
        grid_cell_id = TOWNSHIP_TO_GRID_MAPPING[township_name]
        # Assuming ncdr_grid is a dict where keys are grid_cell_ids
        ncdr_data_for_township = ncdr_grid.get(grid_cell_id, {"error": "Grid cell not found"})

    # 4. Combine the data into a final forecast object
    combined_forecast = {
        "township": township_name,
        "cwa_forecast": {
            "temperature": weather_elements.get("T"),
            "chance_of_rain_12h": weather_elements.get("PoP12h"),
            "weather_description": weather_elements.get("Wx"),
        },
        "ncdr_forecast": ncdr_data_for_township, # This will contain the data from the image grid
    }

    return combined_forecast