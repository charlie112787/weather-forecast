from typing import Dict

COUNTY_NAME_TO_CODE: Dict[str, str] = {
    # 北部地區
    "基隆市": "KEE",
    "臺北市": "TPE",
    "新北市": "NTP",
    "桃園市": "TAO",
    "新竹市": "HSC",
    "新竹縣": "HSH",
    
    # 中部地區
    "苗栗縣": "MIA",
    "臺中市": "TXG",
    "彰化縣": "CHA",
    "南投縣": "NAN",
    "雲林縣": "YUN",
    
    # 南部地區
    "嘉義市": "CYI",
    "嘉義縣": "CYQ",
    "臺南市": "TNN",
    "高雄市": "KHH",
    "屏東縣": "PIF",
    
    # 東部地區
    "宜蘭縣": "ILA",
    "花蓮縣": "HUA",
    "臺東縣": "TTT",
    
    # 離島地區
    "澎湖縣": "PEN",
    "金門縣": "KIN",
    "連江縣": "LIE",  # 馬祖
}

COUNTY_CODE_TO_NAME: Dict[str, str] = {code: name for name, code in COUNTY_NAME_TO_CODE.items()}

# Township codes follow the postal code system
TOWNSHIP_NAME_TO_CODE: Dict[str, str] = {
    # ----------------------
    # 臺北市 (TPE)
    # ----------------------
    "臺北市中正區": "TPE-100",
    "臺北市大同區": "TPE-103",
    "臺北市中山區": "TPE-104",
    "臺北市松山區": "TPE-105",
    "臺北市大安區": "TPE-106",
    "臺北市萬華區": "TPE-108",
    "臺北市信義區": "TPE-110",
    "臺北市士林區": "TPE-111",
    "臺北市北投區": "TPE-112",
    "臺北市內湖區": "TPE-114",
    "臺北市南港區": "TPE-115",
    "臺北市文山區": "TPE-116",

    # ----------------------
    # 基隆市 (KEE)
    # ----------------------
    "基隆市仁愛區": "KEE-200",
    "基隆市信義區": "KEE-201",
    "基隆市中正區": "KEE-202",
    "基隆市中山區": "KEE-203",
    "基隆市安樂區": "KEE-204",
    "基隆市暖暖區": "KEE-205",
    "基隆市七堵區": "KEE-206",

    # ----------------------
    # 新北市 (NTP)
    # ----------------------
    "新北市萬里區": "NTP-207",
    "新北市金山區": "NTP-208",
    "新北市板橋區": "NTP-220",
    "新北市汐止區": "NTP-221",
    "新北市深坑區": "NTP-222",
    "新北市石碇區": "NTP-223",
    "新北市瑞芳區": "NTP-224",
    "新北市平溪區": "NTP-226",
    "新北市雙溪區": "NTP-227",
    "新北市貢寮區": "NTP-228",
    "新北市新店區": "NTP-231",
    "新北市坪林區": "NTP-232",
    "新北市烏來區": "NTP-233",
    "新北市永和區": "NTP-234",
    "新北市中和區": "NTP-235",
    "新北市土城區": "NTP-236",
    "新北市三峽區": "NTP-237",
    "新北市樹林區": "NTP-238",
    "新北市鶯歌區": "NTP-239",
    "新北市三重區": "NTP-241",
    "新北市新莊區": "NTP-242",
    "新北市泰山區": "NTP-243",
    "新北市林口區": "NTP-244",
    "新北市蘆洲區": "NTP-247",
    "新北市五股區": "NTP-248",
    "新北市八里區": "NTP-249",
    "新北市淡水區": "NTP-251",
    "新北市三芝區": "NTP-252",
    "新北市石門區": "NTP-253",

    # ----------------------
    # 桃園市 (TAO)
    # ----------------------
    "桃園市中壢區": "TAO-320",
    "桃園市平鎮區": "TAO-324",
    "桃園市龍潭區": "TAO-325",
    "桃園市楊梅區": "TAO-326",
    "桃園市新屋區": "TAO-327",
    "桃園市觀音區": "TAO-328",
    "桃園市桃園區": "TAO-330",
    "桃園市龜山區": "TAO-333",
    "桃園市八德區": "TAO-334",
    "桃園市大溪區": "TAO-335",
    "桃園市復興區": "TAO-336",
    "桃園市大園區": "TAO-337",
    "桃園市蘆竹區": "TAO-338",

    # ----------------------
    # 新竹市 (HSC) & 新竹縣 (HSH)
    # ----------------------
    "新竹市東區": "HSC-300",
    "新竹市北區": "HSC-300",
    "新竹市香山區": "HSC-300",
    "新竹縣竹北市": "HSH-302",
    "新竹縣湖口鄉": "HSH-303",
    "新竹縣新豐鄉": "HSH-304",
    "新竹縣新埔鎮": "HSH-305",
    "新竹縣關西鎮": "HSH-306",
    "新竹縣芎林鄉": "HSH-307",
    "新竹縣寶山鄉": "HSH-308",
    "新竹縣竹東鎮": "HSH-310",
    "新竹縣五峰鄉": "HSH-311",
    "新竹縣橫山鄉": "HSH-312",
    "新竹縣尖石鄉": "HSH-313",
    "新竹縣北埔鄉": "HSH-314",
    "新竹縣峨眉鄉": "HSH-315",
    
    # ----------------------
    # 苗栗縣 (MIA)
    # ----------------------
    "苗栗縣竹南鎮": "MIA-350",
    "苗栗縣頭份市": "MIA-351",
    "苗栗縣三灣鄉": "MIA-352",
    "苗栗縣南庄鄉": "MIA-353",
    "苗栗縣獅潭鄉": "MIA-354",
    "苗栗縣後龍鎮": "MIA-356",
    "苗栗縣通霄鎮": "MIA-357",
    "苗栗縣苑裡鎮": "MIA-358",
    "苗栗縣苗栗市": "MIA-360",
    "苗栗縣造橋鄉": "MIA-361",
    "苗栗縣頭屋鄉": "MIA-362",
    "苗栗縣公館鄉": "MIA-363",
    "苗栗縣大湖鄉": "MIA-364",
    "苗栗縣泰安鄉": "MIA-365",
    "苗栗縣銅鑼鄉": "MIA-366",
    "苗栗縣三義鄉": "MIA-367",
    "苗栗縣西湖鄉": "MIA-368",
    "苗栗縣卓蘭鎮": "MIA-369",
    
    # ----------------------
    # 臺中市 (TXG)
    # ----------------------
    "臺中市中區": "TXG-400",
    "臺中市東區": "TXG-401",
    "臺中市南區": "TXG-402",
    "臺中市西區": "TXG-403",
    "臺中市北區": "TXG-404",
    "臺中市北屯區": "TXG-406",
    "臺中市西屯區": "TXG-407",
    "臺中市南屯區": "TXG-408",
    "臺中市豐原區": "TXG-420",
    "臺中市后里區": "TXG-421",
    "臺中市石岡區": "TXG-422",
    "臺中市東勢區": "TXG-423",
    "臺中市和平區": "TXG-424",
    "臺中市新社區": "TXG-426",
    "臺中市潭子區": "TXG-427",
    "臺中市大雅區": "TXG-428",
    "臺中市神岡區": "TXG-429",
    "臺中市大肚區": "TXG-432",
    "臺中市沙鹿區": "TXG-433",
    "臺中市龍井區": "TXG-434",
    "臺中市梧棲區": "TXG-435",
    "臺中市清水區": "TXG-436",
    "臺中市大甲區": "TXG-437",
    "臺中市外埔區": "TXG-438",
    "臺中市大安區": "TXG-439",
    "臺中市太平區": "TXG-411",
    "臺中市大里區": "TXG-412",
    "臺中市霧峰區": "TXG-413",
    "臺中市烏日區": "TXG-414",

    # ----------------------
    # 彰化縣 (CHA)
    # ----------------------
    "彰化縣彰化市": "CHA-500",
    "彰化縣芬園鄉": "CHA-502",
    "彰化縣花壇鄉": "CHA-503",
    "彰化縣秀水鄉": "CHA-504",
    "彰化縣鹿港鎮": "CHA-505",
    "彰化縣福興鄉": "CHA-506",
    "彰化縣線西鄉": "CHA-507",
    "彰化縣伸港鄉": "CHA-508",
    "彰化縣員林市": "CHA-510",
    "彰化縣社頭鄉": "CHA-511",
    "彰化縣永靖鄉": "CHA-512",
    "彰化縣埔心鄉": "CHA-513",
    "彰化縣溪湖鎮": "CHA-514",
    "彰化縣大村鄉": "CHA-515",
    "彰化縣埔鹽鄉": "CHA-516",
    "彰化縣田中鎮": "CHA-520",
    "彰化縣北斗鎮": "CHA-521",
    "彰化縣田尾鄉": "CHA-522",
    "彰化縣埤頭鄉": "CHA-523",
    "彰化縣芳苑鄉": "CHA-524",
    "彰化縣二林鎮": "CHA-525",
    "彰化縣竹塘鄉": "CHA-526",
    "彰化縣大城鄉": "CHA-527",
    "彰化縣溪州鄉": "CHA-528",
    
    # ----------------------
    # 南投縣 (NAN)
    # ----------------------
    "南投縣南投市": "NAN-540",
    "南投縣中寮鄉": "NAN-541",
    "南投縣草屯鎮": "NAN-542",
    "南投縣國姓鄉": "NAN-544",
    "南投縣埔里鎮": "NAN-545",
    "南投縣仁愛鄉": "NAN-546",
    "南投縣名間鄉": "NAN-551",
    "南投縣集集鎮": "NAN-552",
    "南投縣水里鄉": "NAN-553",
    "南投縣魚池鄉": "NAN-555",
    "南投縣信義鄉": "NAN-556",
    "南投縣竹山鎮": "NAN-557",
    "南投縣鹿谷鄉": "NAN-558",
    
    # ----------------------
    # 雲林縣 (YUN)
    # ----------------------
    "雲林縣斗南鎮": "YUN-630",
    "雲林縣大埤鄉": "YUN-631",
    "雲林縣虎尾鎮": "YUN-632",
    "雲林縣土庫鎮": "YUN-633",
    "雲林縣褒忠鄉": "YUN-634",
    "雲林縣東勢鄉": "YUN-635",
    "雲林縣臺西鄉": "YUN-636",
    "雲林縣崙背鄉": "YUN-637",
    "雲林縣麥寮鄉": "YUN-638",
    "雲林縣斗六市": "YUN-640",
    "雲林縣古坑鄉": "YUN-646",
    "雲林縣莿桐鄉": "YUN-647",
    "雲林縣林內鄉": "YUN-648",
    "雲林縣西螺鎮": "YUN-648",
    "雲林縣二崙鄉": "YUN-649",
    "雲林縣北港鎮": "YUN-651",
    "雲林縣水林鄉": "YUN-652",
    "雲林縣口湖鄉": "YUN-653",
    "雲林縣四湖鄉": "YUN-654",
    "雲林縣元長鄉": "YUN-655",

    # ----------------------
    # 嘉義市 (CYI) & 嘉義縣 (CYQ)
    # ----------------------
    "嘉義市西區": "CYI-600",
    "嘉義市東區": "CYI-600",
    "嘉義縣番路鄉": "CYQ-602",
    "嘉義縣梅山鄉": "CYQ-603",
    "嘉義縣竹崎鄉": "CYQ-604",
    "嘉義縣阿里山鄉": "CYQ-605",
    "嘉義縣中埔鄉": "CYQ-606",
    "嘉義縣大埔鄉": "CYQ-607",
    "嘉義縣水上鄉": "CYQ-608",
    "嘉義縣鹿草鄉": "CYQ-611",
    "嘉義縣太保市": "CYQ-612",
    "嘉義縣朴子市": "CYQ-613",
    "嘉義縣東石鄉": "CYQ-614",
    "嘉義縣六腳鄉": "CYQ-615",
    "嘉義縣新港鄉": "CYQ-616",
    "嘉義縣民雄鄉": "CYQ-621",
    "嘉義縣大林鎮": "CYQ-622",
    "嘉義縣溪口鄉": "CYQ-623",
    "嘉義縣義竹鄉": "CYQ-624",
    "嘉義縣布袋鎮": "CYQ-625",

    # ----------------------
    # 臺南市 (TNN)
    # ----------------------
    "臺南市中西區": "TNN-700",
    "臺南市東區": "TNN-701",
    "臺南市南區": "TNN-702",
    "臺南市北區": "TNN-704",
    "臺南市安平區": "TNN-708",
    "臺南市安南區": "TNN-709",
    "臺南市永康區": "TNN-710",
    "臺南市歸仁區": "TNN-711",
    "臺南市新化區": "TNN-712",
    "臺南市左鎮區": "TNN-713",
    "臺南市玉井區": "TNN-714",
    "臺南市楠西區": "TNN-715",
    "臺南市南化區": "TNN-716",
    "臺南市仁德區": "TNN-717",
    "臺南市關廟區": "TNN-718",
    "臺南市龍崎區": "TNN-719",
    "臺南市官田區": "TNN-720",
    "臺南市麻豆區": "TNN-721",
    "臺南市佳里區": "TNN-722",
    "臺南市西港區": "TNN-723",
    "臺南市七股區": "TNN-724",
    "臺南市將軍區": "TNN-725",
    "臺南市學甲區": "TNN-726",
    "臺南市北門區": "TNN-727",
    "臺南市新營區": "TNN-730",
    "臺南市後壁區": "TNN-731",
    "臺南市白河區": "TNN-732",
    "臺南市東山區": "TNN-733",
    "臺南市六甲區": "TNN-734",
    "臺南市下營區": "TNN-735",
    "臺南市柳營區": "TNN-736",
    "臺南市鹽水區": "TNN-737",
    "臺南市善化區": "TNN-741",
    "臺南市大內區": "TNN-742",
    "臺南市山上區": "TNN-743",
    "臺南市新市區": "TNN-744",
    "臺南市安定區": "TNN-745",
    
    # ----------------------
    # 高雄市 (KHH)
    # ----------------------
    "高雄市新興區": "KHH-800",
    "高雄市前金區": "KHH-801",
    "高雄市苓雅區": "KHH-802",
    "高雄市前鎮區": "KHH-806",
    "高雄市旗津區": "KHH-805",
    "高雄市小港區": "KHH-812",
    "高雄市鼓山區": "KHH-804",
    "高雄市鹽埕區": "KHH-803",
    "高雄市三民區": "KHH-807",
    "高雄市楠梓區": "KHH-811",
    "高雄市左營區": "KHH-813",
    "高雄市梓官區": "KHH-814",
    "高雄市彌陀區": "KHH-827",
    "高雄市永安區": "KHH-828",
    "高雄市燕巢區": "KHH-824",
    "高雄市橋頭區": "KHH-825",
    "高雄市岡山區": "KHH-820",
    "高雄市路竹區": "KHH-821",
    "高雄市阿蓮區": "KHH-822",
    "高雄市湖內區": "KHH-829",
    "高雄市茄萣區": "KHH-826",
    "高雄市田寮區": "KHH-823",
    "高雄市旗山區": "KHH-842",
    "高雄市美濃區": "KHH-843",
    "高雄市六龜區": "KHH-844",
    "高雄市甲仙區": "KHH-847",
    "高雄市杉林區": "KHH-846",
    "高雄市內門區": "KHH-845",
    "高雄市茂林區": "KHH-851",
    "高雄市桃源區": "KHH-848",
    "高雄市那瑪夏區": "KHH-849",
    "高雄市大樹區": "KHH-840",
    "高雄市仁武區": "KHH-815",
    "高雄市鳥松區": "KHH-833",
    "高雄市大社區": "KHH-815",
    "高雄市鳳山區": "KHH-830",
    "高雄市大寮區": "KHH-831",
    "高雄市林園區": "KHH-832",
    
    # ----------------------
    # 屏東縣 (PIF)
    # ----------------------
    "屏東縣屏東市": "PIF-900",
    "屏東縣三地門鄉": "PIF-901",
    "屏東縣霧臺鄉": "PIF-902",
    "屏東縣瑪家鄉": "PIF-903",
    "屏東縣九如鄉": "PIF-904",
    "屏東縣里港鄉": "PIF-905",
    "屏東縣高樹鄉": "PIF-906",
    "屏東縣鹽埔鄉": "PIF-907",
    "屏東縣長治鄉": "PIF-908",
    "屏東縣麟洛鄉": "PIF-909",
    "屏東縣竹田鄉": "PIF-911",
    "屏東縣內埔鄉": "PIF-912",
    "屏東縣萬丹鄉": "PIF-913",
    "屏東縣潮州鎮": "PIF-920",
    "屏東縣泰武鄉": "PIF-921",
    "屏東縣來義鄉": "PIF-922",
    "屏東縣萬巒鄉": "PIF-923",
    "屏東縣崁頂鄉": "PIF-924",
    "屏東縣新埤鄉": "PIF-925",
    "屏東縣南州鄉": "PIF-926",
    "屏東縣林邊鄉": "PIF-927",
    "屏東縣東港鎮": "PIF-928",
    "屏東縣琉球鄉": "PIF-929",
    "屏東縣佳冬鄉": "PIF-931",
    "屏東縣新園鄉": "PIF-932",
    "屏東縣枋寮鄉": "PIF-940",
    "屏東縣枋山鄉": "PIF-941",
    "屏東縣春日鄉": "PIF-942",
    "屏東縣獅子鄉": "PIF-943",
    "屏東縣車城鄉": "PIF-944",
    "屏東縣牡丹鄉": "PIF-945",
    "屏東縣恆春鎮": "PIF-946",
    "屏東縣滿州鄉": "PIF-947",
    
    # ----------------------
    # 宜蘭縣 (ILA)
    # ----------------------
    "宜蘭縣宜蘭市": "ILA-260",
    "宜蘭縣頭城鎮": "ILA-261",
    "宜蘭縣礁溪鄉": "ILA-262",
    "宜蘭縣壯圍鄉": "ILA-263",
    "宜蘭縣員山鄉": "ILA-264",
    "宜蘭縣羅東鎮": "ILA-265",
    "宜蘭縣三星鄉": "ILA-266",
    "宜蘭縣大同鄉": "ILA-267",
    "宜蘭縣冬山鄉": "ILA-269",
    "宜蘭縣五結鄉": "ILA-268",
    "宜蘭縣蘇澳鎮": "ILA-270",
    "宜蘭縣南澳鄉": "ILA-272",
    
    # ----------------------
    # 花蓮縣 (HUA)
    # ----------------------
    "花蓮縣花蓮市": "HUA-970",
    "花蓮縣新城鄉": "HUA-971",
    "花蓮縣秀林鄉": "HUA-972",
    "花蓮縣吉安鄉": "HUA-973",
    "花蓮縣壽豐鄉": "HUA-974",
    "花蓮縣鳳林鎮": "HUA-975",
    "花蓮縣光復鄉": "HUA-976",
    "花蓮縣豐濱鄉": "HUA-977",
    "花蓮縣瑞穗鄉": "HUA-978",
    "花蓮縣萬榮鄉": "HUA-979",
    "花蓮縣玉里鎮": "HUA-981",
    "花蓮縣富里鄉": "HUA-983",
    "花蓮縣卓溪鄉": "HUA-982",
    
    # ----------------------
    # 臺東縣 (TTT)
    # ----------------------
    "臺東縣臺東市": "TTT-950",
    "臺東縣綠島鄉": "TTT-951",
    "臺東縣蘭嶼鄉": "TTT-952",
    "臺東縣延平鄉": "TTT-953",
    "臺東縣卑南鄉": "TTT-954",
    "臺東縣鹿野鄉": "TTT-955",
    "臺東縣關山鎮": "TTT-956",
    "臺東縣海端鄉": "TTT-957",
    "臺東縣池上鄉": "TTT-958",
    "臺東縣東河鄉": "TTT-959",
    "臺東縣成功鎮": "TTT-961",
    "臺東縣長濱鄉": "TTT-962",
    "臺東縣太麻里鄉": "TTT-963",
    "臺東縣金峰鄉": "TTT-964",
    "臺東縣大武鄉": "TTT-965",
    "臺東縣達仁鄉": "TTT-966",
    
    # ----------------------
    # 澎湖縣 (PEN)
    # ----------------------
    "澎湖縣馬公市": "PEN-880",
    "澎湖縣西嶼鄉": "PEN-881",
    "澎湖縣望安鄉": "PEN-882",
    "澎湖縣七美鄉": "PEN-883",
    "澎湖縣白沙鄉": "PEN-884",
    "澎湖縣湖西鄉": "PEN-885",
    
    # ----------------------
    # 金門縣 (KIN) & 連江縣 (LIE)
    # ----------------------
    "金門縣金沙鎮": "KIN-890",
    "金門縣金湖鎮": "KIN-891",
    "金門縣金寧鄉": "KIN-892",
    "金門縣金城鎮": "KIN-893",
    "金門縣烈嶼鄉": "KIN-894",
    "金門縣烏坵鄉": "KIN-896",
    "連江縣南竿鄉": "LIE-209",
    "連江縣北竿鄉": "LIE-210",
    "連江縣莒光鄉": "LIE-211",
    "連江縣東引鄉": "LIE-212",
}

TOWNSHIP_CODE_TO_NAME: Dict[str, str] = {code: name for name, code in TOWNSHIP_NAME_TO_CODE.items()}

def normalize_name(name: str) -> str:
    """
    Normalize the name by replacing common variants.
    Example: "台北" -> "臺北".
    """
    if not isinstance(name, str):
        return ""
    return name.replace("台", "臺").strip()

def resolve_county_from_township_name(township_name: str) -> str:
    """
    Best-effort derive county name from a full township name by prefix match on known counties.
    Example: "臺北市中正區" -> "臺北市".
    """
    if not isinstance(township_name, str):
        return ""
    normalized = normalize_name(township_name)
    # Prefer longer names first to avoid partial collisions
    for county in sorted(COUNTY_NAME_TO_CODE.keys(), key=len, reverse=True):
        if normalized.startswith(county):
            return county
    return ""

def resolve_township_name(township_name: str) -> str:
    """
    Get the standardized township name.
    Example: "臺北中正" -> "臺北市中正區".
    """
    if not isinstance(township_name, str):
        return ""
    
    normalized = normalize_name(township_name)
    
    # 如果已經是標準格式，直接返回
    if normalized in TOWNSHIP_NAME_TO_CODE:
        return normalized
    
    # 嘗試匹配縣市
    county = resolve_county_from_township_name(normalized)
    if not county:
        return ""
    
    # 移除縣市名稱，只保留地區名稱
    district = normalized[len(county):].strip()
    
    # 嘗試不同的後綴（區、鎮、市、鄉）
    suffixes = ["區", "鎮", "市", "鄉"]
    for suffix in suffixes:
        if district.endswith(suffix):
            break
        if not district.endswith(suffix):
            full_name = f"{county}{district}{suffix}"
            if full_name in TOWNSHIP_NAME_TO_CODE:
                return full_name
    
    # 如果沒有找到匹配的格式，返回空字符串
    return ""


