# --- USER-PROVIDED MAPPING (REQUIRED) ---
# 此字典將鄉鎮名稱對應到 NCDR 圖像上的中心點 (X, Y) 像素座標
TOWNSHIP_TO_CENTER_PIXEL = {
    # ----------------------------------------------------
    # 🌟 離島地區 (使用原 R1_C1, R6_C1, R7_C1 的中心點)
    # ----------------------------------------------------
    # 連江縣 (馬祖) -> (175, 148)
    "連江縣南竿鄉": (175, 148), "連江縣北竿鄉": (175, 148), "連江縣莒光鄉": (175, 148), "連江縣東引鄉": (175, 148),
    # 金門縣 -> (175, 623)
    "金門縣金城鎮": (175, 623), "金門縣金湖鎮": (175, 623), "金門縣金沙鎮": (175, 623), "金門縣金寧鄉": (175, 623), "金門縣烈嶼鄉": (175, 623), "金門縣烏坵鄉": (175, 623),
    # 澎湖縣 -> (175, 718)
    "澎湖縣馬公市": (175, 718), "澎湖縣湖西鄉": (175, 718), "澎湖縣白沙鄉": (175, 718), "澎湖縣西嶼鄉": (175, 718), "澎湖縣望安鄉": (175, 718), "澎湖縣七美鄉": (175, 718),
    
    # ----------------------------------------------------
    # 🌟 北部地區 (使用原 R1 ~ R3 的中心點)
    # ----------------------------------------------------
    # 基隆市 -> (732, 148)
    "基隆市中正區": (732, 148), "基隆市七堵區": (732, 148), "基隆市暖暖區": (732, 148), "基隆市仁愛區": (732, 148), "基隆市中山區": (732, 148), "基隆市安樂區": (732, 148), "基隆市信義區": (732, 148),
    # 臺北市
    "臺北市大同區": (509, 243), "臺北市萬華區": (509, 243), "臺北市士林區": (509, 243), "臺北市北投區": (509, 243), # R2_C4 (509, 243)
    "臺北市中正區": (620, 243), "臺北市中山區": (620, 243), "臺北市松山區": (620, 243), "臺北市大安區": (620, 243), "臺北市內湖區": (620, 243), # R2_C5 (620, 243)
    "臺北市信義區": (732, 243), "臺北市南港區": (732, 243), # R2_C6 (732, 243)
    "臺北市文山區": (620, 338), # R3_C5 (620, 338)
    # 新北市
    "新北市萬里區": (732, 243), "新北市金山區": (732, 243), "新北市汐止區": (732, 243), "新北市瑞芳區": (732, 243), "新北市平溪區": (732, 243), # R2_C6
    "新北市雙溪區": (843, 243), "新北市貢寮區": (843, 243), # R2_C7 (843, 243)
    "新北市淡水區": (398, 338), "新北市三芝區": (398, 338), "新北市石門區": (398, 338), "新北市蘆洲區": (398, 338), "新北市五股區": (398, 338), "新北市泰山區": (398, 338), "新北市林口區": (398, 338), "新北市新莊區": (398, 338), # R3_C3 (398, 338)
    "新北市板橋區": (509, 338), "新北市樹林區": (509, 338), "新北市三峽區": (509, 338), "新北市土城區": (509, 338), "新北市中和區": (509, 338), "新北市永和區": (509, 338), # R3_C4 (509, 338)
    "新北市深坑區": (620, 338), "新北市石碇區": (620, 338), "新北市新店區": (620, 338), "新北市烏來區": (620, 338), # R3_C5
    "新北市坪林區": (732, 338), # R3_C6 (732, 338)
    # 桃園市
    "桃園市新屋區": (287, 338), "桃園市觀音區": (287, 338), "桃園市大園區": (287, 338), # R3_C2 (287, 338)
    "桃園市中壢區": (398, 338), "桃園市平鎮區": (398, 338), "桃園市龍潭區": (398, 338), "桃園市楊梅區": (398, 338), "桃園市桃園區": (398, 338), "桃園市龜山區": (398, 338), "桃園市八德區": (398, 338), "桃園市蘆竹區": (398, 338), # R3_C3
    "桃園市大溪區": (509, 338), "桃園市復興區": (509, 338), # R3_C4
    
    # ----------------------------------------------------
    # 🌟 東部地區 (使用原 R3 ~ R10 的中心點)
    # ----------------------------------------------------
    # 宜蘭縣
    "宜蘭縣宜蘭市": (732, 338), "宜蘭縣羅東鎮": (732, 338), "宜蘭縣頭城鎮": (732, 338), "宜蘭縣礁溪鄉": (732, 338), "宜蘭縣壯圍鄉": (732, 338), "宜蘭縣員山鄉": (732, 338), "宜蘭縣五結鄉": (732, 338), # R3_C6
    "宜蘭縣蘇澳鎮": (732, 433), "宜蘭縣冬山鄉": (732, 433), # R4_C6 (732, 433)
    "宜蘭縣三星鄉": (732, 433), "宜蘭縣大同鄉": (843, 433), "宜蘭縣南澳鄉": (843, 433), # R4_C7 (843, 433)
    # 花蓮縣
    "花蓮縣花蓮市": (732, 528), "花蓮縣新城鄉": (732, 528), "花蓮縣吉安鄉": (732, 528), # R5_C6 (732, 528)
    "花蓮縣壽豐鄉": (732, 623), "花蓮縣鳳林鎮": (732, 623), # R6_C6 (732, 623)
    "花蓮縣光復鄉": (843, 718), "花蓮縣萬榮鄉": (843, 718), "花蓮縣豐濱鄉": (843, 813), # R7_C7, R8_C7 (843, 718)
    "花蓮縣玉里鎮": (732, 813), "花蓮縣富里鄉": (732, 813), # R8_C6 (732, 813)
    "花蓮縣秀林鄉": (843, 528), # R5_C7 (843, 528)
    "花蓮縣瑞穗鄉": (843, 813), "花蓮縣卓溪鄉": (843, 813), # R8_C7
    # 臺東縣
    "臺東縣臺東市": (732, 908), "臺東縣卑南鄉": (732, 908), "臺東縣太麻里鄉": (732, 908), "臺東縣鹿野鄉": (732, 908), # R9_C6 (732, 908)
    "臺東縣成功鎮": (732, 813), "臺東縣關山鎮": (732, 813), "臺東縣東河鄉": (732, 813), "臺東縣池上鄉": (732, 813), # R8_C6
    "臺東縣長濱鄉": (843, 718), # R7_C7
    "臺東縣綠島鄉": (843, 908), "臺東縣延平鄉": (843, 908), # R9_C7 (843, 908)
    "臺東縣蘭嶼鄉": (843, 1003), # R10_C7 (843, 1003)
    "臺東縣大武鄉": (732, 1003), "臺東縣達仁鄉": (732, 1003), "臺東縣金峰鄉": (732, 1003), # R10_C6 (732, 1003)
    "臺東縣海端鄉": (843, 813), # R8_C7

    # ----------------------------------------------------
    # 🌟 中部地區 (使用原 R4 ~ R6 的中心點)
    # ----------------------------------------------------
    # 新竹市/新竹縣
    "新竹市東區": (398, 433), "新竹市北區": (398, 433), "新竹市香山區": (398, 433), # R4_C3 (398, 433)
    "新竹縣竹北市": (398, 433), "新竹縣新埔鎮": (398, 433), "新竹縣湖口鄉": (398, 433), "新竹縣新豐鄉": (398, 433), "新竹縣峨眉鄉": (398, 433), "新竹縣寶山鄉": (398, 433), # R4_C3
    "新竹縣竹東鎮": (509, 433), "新竹縣關西鎮": (509, 433), "新竹縣北埔鄉": (509, 433), "新竹縣芎林鄉": (509, 433), "新竹縣尖石鄉": (509, 433), "新竹縣五峰鄉": (509, 433), # R4_C4 (509, 433)
    # 苗栗縣
    "苗栗縣通霄鎮": (287, 433), "苗栗縣苑裡鎮": (287, 433), "苗栗縣後龍鎮": (287, 433), "苗栗縣西湖鄉": (287, 433), # R4_C2 (287, 433)
    "苗栗縣苗栗市": (398, 433), "苗栗縣竹南鎮": (398, 433), "苗栗縣頭份市": (398, 433), "苗栗縣公館鄉": (398, 433), "苗栗縣銅鑼鄉": (398, 433), "苗栗縣頭屋鄉": (398, 433), "苗栗縣三義鄉": (398, 433), "苗栗縣三灣鄉": (398, 433), # R4_C3
    "苗栗縣卓蘭鎮": (509, 433), "苗栗縣大湖鄉": (509, 433), "苗栗縣南庄鄉": (509, 433), "苗栗縣獅潭鄉": (509, 433), "苗栗縣泰安鄉": (509, 433), # R4_C4
    # 臺中市
    "臺中市大甲區": (287, 528), "臺中市清水區": (287, 528), "臺中市沙鹿區": (287, 528), "臺中市梧棲區": (287, 528), "臺中市外埔區": (287, 528), "臺中市大安區": (287, 528), "臺中市大肚區": (287, 528), "臺中市龍井區": (287, 528), # R5_C2
    "臺中市中區": (398, 528), "臺中市東區": (398, 528), "臺中市西區": (398, 528), "臺中市南區": (398, 528), "臺中市北區": (398, 528), "臺中市西屯區": (398, 528), "臺中市南屯區": (398, 528), "臺中市北屯區": (398, 528), "臺中市豐原區": (398, 528), "臺中市神岡區": (398, 528), "臺中市潭子區": (398, 528), "臺中市大雅區": (398, 528), "臺中市烏日區": (398, 528), # R5_C3 (398, 528)
    "臺中市東勢區": (509, 528), "臺中市新社區": (509, 528), "臺中市石岡區": (509, 528), "臺中市霧峰區": (509, 528), "臺中市太平區": (509, 528), # R5_C4
    "臺中市和平區": (620, 528), # R5_C5 (620, 528)
    "臺中市后里區": (398, 433), # R4_C3
    # 彰化縣
    "彰化縣鹿港鎮": (287, 528), "彰化縣和美鎮": (287, 528), "彰化縣線西鄉": (287, 528), "彰化縣伸港鄉": (287, 528), "彰化縣福興鄉": (287, 528), # R5_C2
    "彰化縣彰化市": (398, 528), "彰化縣秀水鄉": (398, 528), "彰化縣花壇鄉": (398, 528), "彰化縣芬園鄉": (398, 528), "彰化縣大村鄉": (398, 528), # R5_C3
    "彰化縣北斗鎮": (287, 623), "彰化縣溪湖鎮": (287, 623), "彰化縣埤頭鄉": (287, 623), "彰化縣芳苑鄉": (287, 623), "彰化縣大城鄉": (287, 623), "彰化縣竹塘鄉": (287, 623), "彰化縣溪州鄉": (287, 623), "彰化縣埔鹽鄉": (287, 623), # R6_C2
    "彰化縣員林市": (398, 623), "彰化縣田中鎮": (398, 623), "彰化縣社頭鄉": (398, 623), "彰化縣二水鄉": (398, 623), "彰化縣永靖鄉": (398, 623), "彰化縣埔心鄉": (398, 623), # R6_C3 (398, 623)
    # 南投縣
    "南投縣南投市": (509, 528), "南投縣草屯鎮": (509, 528), # R5_C4
    "南投縣埔里鎮": (620, 528), "南投縣國姓鄉": (620, 528), # R5_C5
    "南投縣竹山鎮": (509, 623), "南投縣集集鎮": (509, 623), "南投縣名間鄉": (509, 623), "南投縣鹿谷鄉": (509, 623), "南投縣中寮鄉": (509, 623), "南投縣水里鄉": (509, 623), # R6_C4 (509, 623)
    "南投縣魚池鄉": (620, 623), "南投縣仁愛鄉": (620, 623), # R6_C5
    "南投縣信義鄉": (620, 718), # R7_C5 (620, 718)
    # 雲林縣
    "雲林縣虎尾鎮": (287, 623), "雲林縣西螺鎮": (287, 623), "雲林縣土庫鎮": (287, 623), "雲林縣崙背鄉": (287, 623), "雲林縣麥寮鄉": (287, 623), "雲林縣東勢鄉": (287, 623), "雲林縣褒忠鄉": (287, 623), "雲林縣臺西鄉": (287, 623), "雲林縣元長鄉": (287, 623), # R6_C2
    "雲林縣斗六市": (398, 623), "雲林縣斗南鎮": (398, 623), "雲林縣大埤鄉": (398, 623), "雲林縣莿桐鄉": (398, 623), # R6_C3
    "雲林縣古坑鄉": (509, 623), "雲林縣林內鄉": (509, 623), # R6_C4
    "雲林縣北港鎮": (287, 718), "雲林縣四湖鄉": (287, 718), "雲林縣口湖鄉": (287, 718), "雲林縣水林鄉": (287, 718), # R7_C2 (287, 718)
    "雲林縣嘉義縣": (398, 718), # R7_C3
    
    # ----------------------------------------------------
    # 🌟 南部地區 (使用原 R7 ~ R10 的中心點)
    # ----------------------------------------------------
    # 嘉義市/嘉義縣
    "嘉義市東區": (398, 718), "嘉義市西區": (398, 718), # R7_C3
    "嘉義縣太保市": (287, 718), "嘉義縣朴子市": (287, 718), "嘉義縣新港鄉": (287, 718), "嘉義縣六腳鄉": (287, 718), "嘉義縣東石鄉": (287, 718), "嘉義縣鹿草鄉": (287, 718), # R7_C2
    "嘉義縣大林鎮": (398, 718), "嘉義縣民雄鄉": (398, 718), "嘉義縣溪口鄉": (398, 718), "嘉義縣中埔鄉": (398, 718), # R7_C3
    "嘉義縣番路鄉": (509, 718), "嘉義縣竹崎鄉": (509, 718), "嘉義縣梅山鄉": (509, 718), # R7_C4 (509, 718)
    "嘉義縣布袋鎮": (287, 813), "嘉義縣義竹鄉": (287, 813), # R8_C2 (287, 813)
    "嘉義縣大埔鄉": (509, 813), "嘉義縣阿里山鄉": (509, 813), # R8_C4 (509, 813)
    # 臺南市
    "臺南市中西區": (287, 718), "臺南市南區": (287, 718), "臺南市北區": (287, 718), "臺南市安平區": (287, 718), "臺南市安南區": (287, 718), "臺南市麻豆區": (287, 718), "臺南市佳里區": (287, 718), "臺南市西港區": (287, 718), "臺南市七股區": (287, 718), "臺南市將軍區": (287, 718), "臺南市學甲區": (287, 718), "臺南市北門區": (287, 718), "臺南市安定區": (287, 718), # R7_C2
    "臺南市東區": (398, 718), "臺南市永康區": (398, 718), "臺南市新化區": (398, 718), "臺南市玉井區": (398, 718), "臺南市官田區": (398, 718), "臺南市新營區": (398, 718), "臺南市後壁區": (398, 718), "臺南市白河區": (398, 718), "臺南市東山區": (398, 718), "臺南市六甲區": (398, 718), "臺南市下營區": (398, 718), "臺南市柳營區": (398, 718), "臺南市鹽水區": (398, 718), "臺南市善化區": (398, 718), "臺南市大內區": (398, 718), "臺南市山上區": (398, 718), "臺南市新市區": (398, 718), # R7_C3
    "臺南市歸仁區": (398, 813), "臺南市左鎮區": (398, 813), "臺南市仁德區": (398, 813), "臺南市關廟區": (398, 813), "臺南市龍崎區": (398, 813), # R8_C3 (398, 813)
    "臺南市楠西區": (509, 718), # R7_C4
    "臺南市南化區": (509, 813), # R8_C4
    # 高雄市
    "高雄市鹽埕區": (287, 813), "高雄市鼓山區": (287, 813), "高雄市楠梓區": (287, 813), "高雄市左營區": (287, 813), "高雄市岡山區": (287, 813), "高雄市路竹區": (287, 813), "高雄市梓官區": (287, 813), "高雄市彌陀區": (287, 813), "高雄市永安區": (287, 813), "高雄市湖內區": (287, 813), # R8_C2
    "高雄市新興區": (398, 813), "高雄市前金區": (398, 813), "高雄市苓雅區": (398, 813), "高雄市前鎮區": (398, 813), "高雄市三民區": (398, 813), "高雄市仁武區": (398, 813), "高雄市大社區": (398, 813), "高雄市阿蓮區": (398, 813), "高雄市田寮區": (398, 813), "高雄市燕巢區": (398, 813), "高雄市橋頭區": (398, 813), "高雄市鳳山區": (398, 813), "高雄市鳥松區": (398, 813), "高雄市大樹區": (398, 813), "高雄市內門區": (398, 813), # R8_C3
    "高雄市小港區": (398, 908), "高雄市大寮區": (398, 908), "高雄市林園區": (398, 908), # R9_C3 (398, 908)
    "高雄市旗津區": (287, 908), # R9_C2
    "高雄市旗山區": (509, 813), "高雄市美濃區": (509, 813), "高雄市六龜區": (509, 813), "高雄市杉林區": (509, 813), "高雄市甲仙區": (509, 813), "高雄市茂林區": (509, 813), # R8_C4
    "高雄市桃源區": (620, 908), # R9_C5 (620, 908)
    "高雄市那瑪夏區": (620, 813), # R8_C5 (620, 813)
    # 屏東縣
    "屏東縣東港鎮": (398, 908), "屏東縣新園鄉": (398, 908), # R9_C3
    "屏東縣琉球鄉": (287, 908), # R9_C2
    "屏東縣屏東市": (509, 908), "屏東縣潮州鎮": (509, 908), "屏東縣萬丹鄉": (509, 908), "屏東縣長治鄉": (509, 908), "屏東縣麟洛鄉": (509, 908), "屏東縣九如鄉": (509, 908), "屏東縣鹽埔鄉": (509, 908), "屏東縣萬巒鄉": (509, 908), "屏東縣內埔鄉": (509, 908), "屏東縣竹田鄉": (509, 908), "屏東縣新埤鄉": (509, 908), "屏東縣崁頂鄉": (509, 908), # R9_C4 (509, 908)
    "屏東縣霧臺鄉": (620, 908), "屏東縣瑪家鄉": (620, 908), "屏東縣泰武鄉": (620, 908), "屏東縣三地門鄉": (620, 908), # R9_C5
    "屏東縣林邊鄉": (398, 1003), # R10_C3 (398, 1003)
    "屏東縣枋寮鄉": (509, 1003), "屏東縣南州鄉": (509, 1003), "屏東縣佳冬鄉": (509, 1003), "屏東縣車城鄉": (509, 1003), # R10_C4 (509, 1003)
    "屏東縣恆春鎮": (620, 1003), "屏東縣滿州鄉": (620, 1003), "屏東縣來義鄉": (620, 1003), "屏東縣春日鄉": (620, 1003), "屏東縣獅子鄉": (620, 1003), "屏東縣牡丹鄉": (620, 1003), # R10_C5

}
# --- END OF USER-PROVIDED MAPPING ---

# --- NEW CONFIGURATION ---
# 圓形掃描半徑 (像素)
RADIUS_PIXELS = 10
# --- END OF NEW CONFIGURATION ---

def get_forecast_for_township(township_name: str, all_cwa_data: dict, ncdr_image_data):
    """
    提取並合併特定鄉鎮的預報數據。

    Args:
        township_name: 鄉鎮全名 (e.g., "臺北市中正區").
        all_cwa_data: CWA 鄉鎮預報 API 的完整 JSON 回應。
        ncdr_image_data: 快取的 PIL Image 物件，用於進行像素掃描。

    Returns:
        一個包含綜合預報的字典，如果找不到則為 None。
    """
    if not all_cwa_data or 'records' not in all_cwa_data or not all_cwa_data['records']['locations']:
        print("Error: CWA data is invalid or empty.")
        return None

    # 1. 找到 CWA 數據中的特定鄉鎮
    cwa_location_data = None
    for loc in all_cwa_data['records']['locations'][0]['location']:
        if loc['locationName'] == township_name:
            cwa_location_data = loc
            break
    
    if not cwa_location_data:
        print(f"Error: Township '{township_name}' not found in CWA data.")
        return None

    # 2. 從 CWA 數據中提取相關天氣元素
    weather_elements = {}
    for element in cwa_location_data['weatherElement']:
        element_name = element['elementName']
        # 確保 time 列表不為空，並且 elementValue 列表不為空
        element_value = element['time'][0]['elementValue'][0]['value'] if element['time'] and element['time'][0]['elementValue'] else "N/A"
        weather_elements[element_name] = element_value

    # 3. 根據新的邏輯，從 NCDR 圖像中獲取最大降雨值
    if township_name not in TOWNSHIP_TO_CENTER_PIXEL:
        print(f"Warning: Township '{township_name}' not in TOWNSHIP_TO_CENTER_PIXEL.")
        ncdr_data_for_township = {"error": "Mapping not found"}
    else:
        center_x, center_y = TOWNSHIP_TO_CENTER_PIXEL[township_name]
        
        from server.core import data_fetcher
        max_rainfall_value = data_fetcher.get_max_rainfall_in_radius(
            img=ncdr_image_data, 
            center_x=center_x, 
            center_y=center_y, 
            radius=RADIUS_PIXELS
        )
        
        ncdr_data_for_township = {
            "max_rainfall_mm_in_radius": max_rainfall_value,
            "center_pixel_xy": (center_x, center_y),
            "scan_radius": RADIUS_PIXELS
        }

    # 4. 合併數據
    combined_forecast = {
        "township": township_name,
        "cwa_forecast": {
            "temperature": weather_elements.get("T"),
            "chance_of_rain_12h": weather_elements.get("PoP12h"),
            "weather_description": weather_elements.get("Wx"),
        },
        "ncdr_forecast": ncdr_data_for_township,
    }

    return combined_forecast
